<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ViralPX Admin Dashboard</title>
    <!-- Google Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #E50914; --dark: #0f0f0f; --card: #1f1f1f; --text: #e5e5e5; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* Login Screen */
        #login-section { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--card); padding: 40px; border-radius: 12px; width: 350px; text-align: center; border: 1px solid #333; }
        .login-box input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: none; color: white; border-radius: 6px; box-sizing: border-box; }
        
        /* Dashboard Layout */
        #dashboard-section { display: none; width: 100%; height: 100%; display: flex; }
        .sidebar { width: 250px; background: #000; padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .brand { color: var(--primary); font-size: 24px; font-weight: 800; margin-bottom: 40px; letter-spacing: 1px; }
        .menu-item { padding: 12px; margin-bottom: 5px; cursor: pointer; border-radius: 6px; color: #888; font-weight: 600; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: var(--card); color: white; }
        .logout { margin-top: auto; color: #ff4444; }

        .main-content { flex: 1; padding: 30px; overflow-y: auto; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card); padding: 20px; border-radius: 10px; border: 1px solid #333; }
        .stat-number { font-size: 32px; font-weight: 800; color: white; margin-top: 5px; }
        .stat-label { color: #888; font-size: 14px; text-transform: uppercase; }

        /* Forms */
        .panel { background: var(--card); padding: 25px; border-radius: 12px; border: 1px solid #333; margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        
        label { font-size: 12px; color: #aaa; text-transform: uppercase; font-weight: 700; display: block; margin-bottom: 8px; }
        input, textarea, select { width: 100%; padding: 12px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 120px; resize: vertical; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 14px; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-primary:hover { background: #ff0f1f; }
        .btn-sec { background: #444; color: white; }

        /* Movie List */
        .list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .movie-item { display: flex; align-items: center; background: #151515; padding: 10px; margin-bottom: 8px; border-radius: 8px; border-left: 4px solid var(--primary); }
        .movie-item img { width: 60px; height: 34px; object-fit: cover; margin-right: 15px; border-radius: 4px; }
        .movie-info { flex: 1; }
        .movie-actions button { margin-left: 5px; padding: 6px 12px; font-size: 12px; }
    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-section">
        <div class="login-box">
            <h2 style="color: var(--primary);">Admin Access</h2>
            <input type="email" id="email" placeholder="Admin Email">
            <input type="password" id="password" placeholder="Password">
            <button class="btn-primary" id="loginBtn" style="margin-top: 10px;">Login Dashboard</button>
            <p id="loginMsg" style="color: red; font-size: 13px; margin-top: 10px;"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-section" style="display:none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="brand">VIRALPX</div>
            <div class="menu-item active">Dashboard</div>
            <div class="menu-item" onclick="window.open('index.html')">View Site â†—</div>
            <div class="menu-item logout" id="logoutBtn">Logout</div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            
            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Movies</div>
                    <div class="stat-number" id="totalMov">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Views</div>
                    <div class="stat-number" id="totalViews">0</div>
                </div>
                <div class="stat-card" style="border-color: var(--primary);">
                    <div class="stat-label">System Status</div>
                    <div class="stat-number" style="font-size: 20px; color: #4db8ff; margin-top:12px;">Scale: Pro</div>
                </div>
            </div>

            <!-- Form -->
            <div class="panel">
                <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                    <h3 style="margin:0;">Manage Content</h3>
                    <button class="btn-sec" id="cancelBtn" style="display:none;">Cancel Edit</button>
                </div>
                
                <input type="hidden" id="editKey">
                
                <div class="form-grid">
                    <div>
                        <label>Movie Title</label>
                        <input type="text" id="mTitle" placeholder="Ex: Deadpool & Wolverine">
                    </div>
                    <div>
                        <label>Thumbnail URL (1280x720)</label>
                        <input type="text" id="mThumb" placeholder="https://...">
                    </div>
                    <div class="full-width">
                        <label>Stream Links (One per line: Name | URL)</label>
                        <textarea id="mLinks" placeholder="Full Movie | https://link...&#10;Part 2 | https://link..."></textarea>
                    </div>
                    <div>
                        <label>Sort Order (1 = Top)</label>
                        <input type="number" id="mOrder" value="999">
                    </div>
                    <div style="display:flex; align-items:end;">
                        <button class="btn-primary" id="saveBtn">Publish Movie</button>
                    </div>
                </div>
                <p id="msg" style="text-align: center; margin-top: 15px; font-weight: bold;"></p>
            </div>

            <!-- List -->
            <div class="list-header">
                <h3>Library</h3>
                <input type="text" id="searchBox" placeholder="Search movies..." style="width: 200px; padding: 8px;">
            </div>
            <div id="movieList">Loading database...</div>

        </div>
    </div>

    <script type="module">
        import { db, ref, push, set, onValue, remove, update, auth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from './firebase-config.js';

        // --- AUTH SYSTEM ---
        onAuthStateChanged(auth, user => {
            if (user) {
                document.getElementById('login-section').style.display = 'none';
                document.getElementById('dashboard-section').style.display = 'flex';
                loadData();
            } else {
                document.getElementById('login-section').style.display = 'flex';
                document.getElementById('dashboard-section').style.display = 'none';
            }
        });

        document.getElementById('loginBtn').addEventListener('click', () => {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            signInWithEmailAndPassword(auth, e, p).catch(err => document.getElementById('loginMsg').innerText = err.message);
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        // --- DASHBOARD LOGIC ---
        const inputs = {
            t: document.getElementById('mTitle'),
            th: document.getElementById('mThumb'),
            l: document.getElementById('mLinks'),
            o: document.getElementById('mOrder'),
            k: document.getElementById('editKey')
        };
        let allMovies = [];

        function loadData() {
            onValue(ref(db, 'movies'), (snap) => {
                const data = snap.val();
                const list = document.getElementById('movieList');
                list.innerHTML = "";
                
                let count = 0;
                let views = 0;
                allMovies = [];

                if(data){
                    // Process Data
                    Object.entries(data).forEach(([k, v]) => {
                        count++;
                        views += (v.views || 0);
                        allMovies.push({key: k, ...v});
                    });
                    
                    // Sort & Render
                    allMovies.sort((a, b) => (a.order - b.order));
                    renderList(allMovies);
                }
                
                // Update Stats
                document.getElementById('totalMov').innerText = count;
                document.getElementById('totalViews').innerText = views.toLocaleString();
            });
        }

        function renderList(movies) {
            const list = document.getElementById('movieList');
            list.innerHTML = "";
            movies.forEach(m => {
                const div = document.createElement('div');
                div.className = 'movie-item';
                div.innerHTML = `
                    <img src="${m.thumbnail}">
                    <div class="movie-info">
                        <div style="font-weight:600;">${m.title}</div>
                        <div style="font-size:12px; color:#888;">Order: ${m.order} | Views: ${m.views || 0}</div>
                    </div>
                    <div class="movie-actions">
                        <button class="btn-sec" onclick="window.editMov('${m.key}')">Edit</button>
                        <button style="background:#800; color:white; border:none; border-radius:4px; cursor:pointer;" onclick="window.delMov('${m.key}')">Del</button>
                    </div>
                `;
                list.appendChild(div);
            });
        }

        // Search
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = allMovies.filter(m => m.title.toLowerCase().includes(term));
            renderList(filtered);
        });

        // Add / Update Logic
        document.getElementById('saveBtn').addEventListener('click', () => {
            if(!inputs.t.value || !inputs.l.value) return alert("Title and Link Required");
            
            // Parse Links
            const parts = [];
            inputs.l.value.split('\n').forEach(line => {
                if(line.includes('|')) {
                    const [n, u] = line.split('|');
                    parts.push({ name: n.trim(), link: u.trim() });
                } else if(line.trim()) {
                    parts.push({ name: "Full Movie", link: line.trim() });
                }
            });

            const payload = {
                title: inputs.t.value,
                thumbnail: inputs.th.value,
                episodes: parts,
                order: Number(inputs.o.value),
                views: 0 // Default
            };

            if(inputs.k.value) {
                delete payload.views; // Views reset mat karna
                update(ref(db, 'movies/' + inputs.k.value), payload).then(() => resetForm());
            } else {
                push(ref(db, 'movies'), payload).then(() => resetForm());
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        // Global Funcs
        window.editMov = (key) => {
            const m = allMovies.find(x => x.key === key);
            inputs.k.value = key; inputs.t.value = m.title; inputs.th.value = m.thumbnail; inputs.o.value = m.order;
            
            let linkTxt = "";
            if(m.episodes) m.episodes.forEach(e => linkTxt += `${e.name} | ${e.link}\n`);
            else if(m.streamUrl) linkTxt = `Full Movie | ${m.streamUrl}`;
            
            inputs.l.value = linkTxt.trim();
            document.getElementById('saveBtn').innerText = "Update Movie";
            document.getElementById('saveBtn').style.background = "#0088cc";
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0,0);
        };

        window.delMov = (k) => { if(confirm("Delete Permanently?")) remove(ref(db, 'movies/'+k)); };

        function resetForm() {
            inputs.t.value = ''; inputs.th.value = ''; inputs.l.value = ''; inputs.o.value = '999'; inputs.k.value = '';
            document.getElementById('saveBtn').innerText = "Publish Movie";
            document.getElementById('saveBtn').style.background = "#E50914";
            document.getElementById('cancelBtn').style.display = "none";
            document.getElementById('msg').innerText = "Action Success!";
            setTimeout(() => document.getElementById('msg').innerText = "", 2000);
        }
    </script>
</body>
</html>
