<!-- admin.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ViralPX</title>
    <style>
        body { background: #0f0f0f; color: #ddd; font-family: 'Segoe UI', sans-serif; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; }
        .panel { background: #1f1f1f; padding: 20px; border-radius: 10px; border: 1px solid #333; margin-bottom: 30px; }
        input, textarea { width: 100%; padding: 12px; margin: 5px 0 15px 0; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 150px; resize: vertical; font-family: monospace; }
        label { font-size: 12px; color: #aaa; text-transform: uppercase; font-weight: bold; }
        .primary-btn { background: #E50914; color: white; padding: 12px; width: 100%; border: none; cursor: pointer; font-weight: bold; }
        
        .list-item { background: #1a1a1a; padding: 10px; margin-bottom: 5px; border-left: 3px solid #E50914; display: flex; justify-content: space-between; }
        .del-btn { background: #900; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="container">
        <h2 style="text-align: center;">ViralPX Admin</h2>

        <div class="panel">
            <h3>Add / Edit Movie</h3>
            <input type="hidden" id="editKey">
            
            <label>Movie Title</label>
            <input type="text" id="mTitle" placeholder="Ex: Money Heist Season 1">
            
            <label>Thumbnail URL</label>
            <input type="text" id="mThumb" placeholder="https://image-link.com...">
            
            <label>Stream Links (Format: Name | URL)</label>
            <textarea id="mLinks" placeholder="Episode 1 | https://link1.com&#10;Episode 2 | https://link2.com&#10;Part 3 | https://link3.com"></textarea>
            <small style="color: gray;">Note: Har naye part ke liye 'Enter' dabayein.</small>

            <label>Sort Order</label>
            <input type="number" id="mOrder" placeholder="1" value="999">

            <button class="primary-btn" id="saveBtn">Save Movie</button>
            <button id="cancelBtn" style="display:none; width:100%; margin-top:10px; padding:10px;">Cancel</button>
        </div>

        <h3>Existing Movies</h3>
        <div id="movieList">Loading...</div>
    </div>

    <script type="module">
        import { db, ref, push, set, onValue, remove, update } from './firebase-config.js';

        const inputs = {
            t: document.getElementById('mTitle'),
            th: document.getElementById('mThumb'),
            l: document.getElementById('mLinks'), // Changed to Textarea
            o: document.getElementById('mOrder'),
            k: document.getElementById('editKey')
        };

        // SAVE BUTTON LOGIC
        document.getElementById('saveBtn').addEventListener('click', () => {
            if(!inputs.t.value || !inputs.l.value) return alert("Title and Links required");

            // Process Links (Textarea to Array)
            const rawLines = inputs.l.value.split('\n');
            const parts = [];
            
            rawLines.forEach(line => {
                if(line.includes('|')) {
                    const [name, url] = line.split('|');
                    if(name && url) parts.push({ name: name.trim(), link: url.trim() });
                } else if(line.trim() !== "") {
                    // Agar bina '|' ke link dala hai to "Full Movie" maan lo
                    parts.push({ name: "Full Movie", link: line.trim() });
                }
            });

            if(parts.length === 0) return alert("Invalid Link Format! Use: Name | Link");

            const data = {
                title: inputs.t.value,
                thumbnail: inputs.th.value,
                episodes: parts, // New Array Structure
                order: Number(inputs.o.value),
                views: 0
            };

            if(inputs.k.value) {
                delete data.views; 
                update(ref(db, 'movies/' + inputs.k.value), data).then(() => resetForm());
            } else {
                push(ref(db, 'movies'), data).then(() => resetForm());
            }
        });

        document.getElementById('cancelBtn').addEventListener('click', resetForm);

        // LOAD LIST
        onValue(ref(db, 'movies'), (snap) => {
            const list = document.getElementById('movieList');
            list.innerHTML = "";
            const data = snap.val();
            if(data){
                Object.entries(data).reverse().forEach(([key, val]) => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `<span>${val.title}</span> <button class="del-btn" onclick="delMov('${key}')">Delete</button>`;
                    div.onclick = (e) => { if(e.target.className !== 'del-btn') editMov(key, val) };
                    list.appendChild(div);
                });
            }
        });

        window.delMov = k => { if(confirm("Delete?")) remove(ref(db, 'movies/'+k)); };
        
        window.editMov = (key, data) => {
            inputs.k.value = key; inputs.t.value = data.title; inputs.th.value = data.thumbnail; inputs.o.value = data.order;
            
            // Convert Array back to Text format
            let text = "";
            if(data.episodes) {
                data.episodes.forEach(p => text += `${p.name} | ${p.link}\n`);
            } else if(data.streamUrl) {
                text = `Full Movie | ${data.streamUrl}`; // Old data support
            }
            inputs.l.value = text.trim();

            document.getElementById('saveBtn').innerText = "Update Movie";
            document.getElementById('cancelBtn').style.display = 'block';
            window.scrollTo(0,0);
        };

        function resetForm() {
            inputs.t.value = ''; inputs.th.value = ''; inputs.l.value = ''; inputs.o.value = '999'; inputs.k.value = '';
            document.getElementById('saveBtn').innerText = "Save Movie";
            document.getElementById('cancelBtn').style.display = 'none';
        }
    </script>
</body>
</html>
